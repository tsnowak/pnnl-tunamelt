
# Introduction

This code accompanies the paper `TBD` which studies possible methods for filtering turbine motion out of underwater acoustic camera videos in order to assist with fish detection and underwater turbine monitoring.

We operate on `.mp4` files transcoded from `.ddfs` generated by a DIDSON acoustic camera due to their greater ease of use and the plentiful tools available for doing so.

The data set associated with can be found at `TODO`.

# Getting Started

## Downloading conda

All package dependencies for this code base are handled by `conda` and `PyPi`. To use this repository, these managers will need to be installed:

- [Miniconda](https://docs.conda.io/en/latest/miniconda.html): Miniconda setup script downloads. Will also contain pip/PyPi.

## Conda environment setup

Once `conda` is setup on your machine, you can go ahead and setup the environment.

``` bash
# creates a conda environment for this code
conda create -n turbx python=3.9

# activates the new environment
conda activate turbx

# installs the software for this project into the environment
conda env update --file env.yml
```

## Data directories symlink

The code relies on certain directories. These are as follows: 

``` bash
ln -s <path/to/my/data> $REPO_PATH/data
ln -s <path/to/my/data> $REPO_PATH/notebooks/data
```

``` bash
$REPO_PATH/data
- mp4
- labels/cvat-video-1.1
```
Currently `cvat-video-1.1` is the only format of labels supported

# Data Set


## Video Label Data Structure

During data set creation video labels are converted from `xml` files into python objects. Below is the structure of the python objects returned by the data loader:

``` python
{'test': [
    {
        'filename': '2010-09-08_074500_HF_S002_S001.mp4',
        'tracks': [
            {
                'frames': [
                    {'box': ((486, 1011), (542, 1062)),
                    'frame': 16,
                    'keyframe': 1,
                    'occluded': 0,
                    'outside': 0},
                    {'box': ((455, 1016), (511, 1067)), ...
                ]
                'label': 'target',
                'track_id': 0
            },
                'frames': ...
        ],
        'video_id': 12,
        'video_length': 160,
        'video_shape': {'height': 1792, 'width': 1032}
    }
]
} 
```

# CVAT

CVAT is an open-source image and video labeling tool that can be downloaded and stood up. We used CVAT's docker image to create a video labeling platform for our expert-annotators to identify targets of interest in video.

## Exporting Vdieo Annotations from CVAT

Exporting all project annotations does not preserve per-video frame information. We therefore have to export each task manually. To do so using the CVAT CLI create a python environment [via the linked](https://openvinotoolkit.github.io/cvat/docs/manual/advanced/cli/#usage) then use the below to export annotations from a specific task (or just download annotations for each video by hand):

``` bash
# format = CVAT for images 1.1
# task = 103
cli.py dump --format "CVAT for images 1.1" 103 output.zip
```

# Downloading the Dataset

The data set is hosted on pcloud. A [web interface link](http://u.pc.cd/k76italK) is provided, but to need to create a direct download link if we want to download the data set via terminal.

We will use pcloud's web API to generate a direct download link. To do so, we take the code parameter in web interface link, and pass it into the pcloud web API as shown below. **Note, this link will always remain the same!**
```
https://api.pcloud.com/getpublinkdownload?code=k76italK&forcedownload=0
```
This will return a page like the below. **This will change for each request**, as the direct download link always expires in one day:
```
{
	"result": 0,
	"expires": "Wed, 03 May 2023 04:06:08 +0000",
	"dwltag": "ywtWXDIDIP8bkcqlT1KG35",
	"path": "\/cBZnt4E1dZHhHGlcZZZj05Mo7Zg5ZZGiFZkZnR6fMJZR4ZszZ7zZPHZuHZSpZ3HZVFZlpZY5ZbLZ04ZTRZC4Ztd8tVZhaYWhc86DPXLdkfDV0Q8PQaGYeqk\/AFD-ME.tar.gz",
	"hosts": [
		"p-def4.pcloud.com",
		"c383.pcloud.com"
	]
}
```
We can then choose a host to download from - in this case either `p-def4.pcloud.com` or `c383.pcloud.com` - and append the `path` with backslashes removed - `/cBZnt4E1dZHhHGlcZZZj05Mo7Zg5ZZGiFZkZnR6fMJZR4ZszZ7zZPHZuHZSpZ3HZVFZlpZY5ZbLZ04ZTRZC4Ztd8tVZhaYWhc86DPXLdkfDV0Q8PQaGYeqk/AFD-ME.tar.gz` - to the AFD-ME file to create the direct download link. The URL for this generated (and likely now expired) direct download path is given below.
```
https://p-def4.pcloud.com/cBZnt4E1dZHhHGlcZZZMG0Mo7Zg5ZZGiFZkZnR6fMJZR4ZszZ7zZPHZuHZSpZ3HZVFZlpZY5ZbLZ04ZTRZC4Ztd8tVZ6wcSuxqImyBvBT1so6vuBLEV23UX/AFD-ME.tar.gz
```
